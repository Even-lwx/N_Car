/*********************************************************************************************************************
 * TC264 Opensourec Library 即（TC264 开源库）是一个基于官方 SDK 接口的第三方开源库
 * Copyright (c) 2022 SEEKFREE 逐飞科技
 *
 * 文件名称          delayed_stop.c - 延迟停车功能库
 * 功能说明          提供延迟停车功能，在指定时间后自动禁用PID控制并停止电机
 * 开发环境          ADS v1.9.4
 * 适用平台          TC264D
 ********************************************************************************************************************/

#include "delayed_stop.h"
#include "zf_common_headfile.h"

// *************************** 延迟停车状态结构体 ***************************
typedef struct
{
    bool is_active;           // 延迟停车是否激活
    uint32 delay_time_ms;     // 延迟时间（毫秒）
    uint32 remaining_time_ms; // 剩余时间（毫秒）
} delayed_stop_state_t;

// *************************** 全局变量 ***************************
uint32 delayed_stop_time_ms = 5000; // 默认5秒，可在菜单中调整
uint32 delayed_stop_enabled = 0;    // 默认禁用，可在菜单中调整 (0=禁用, 1=启用)

// *************************** 静态变量 ***************************
static delayed_stop_state_t state = {false, 0, 0}; // 延迟停车状态

// *************************** 外部变量引用 ***************************
extern volatile bool enable; // PID使能标志(定义在pid.c中)

// *************************** 函数实现 ***************************

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     启动延迟停车
// 参数说明     delay_ms: 延迟时间(毫秒)
// 返回参数     void
// 使用示例     delayed_stop_start(5000); // 5秒后停车
// 备注信息     启动延迟停车计时器，到期后自动禁用PID控制、停止所有电机并响蜂鸣器
//              如果delay_ms为0，则立即停车
//              如果delayed_stop_enabled=0(禁用)，则不会启动延迟停车
//-------------------------------------------------------------------------------------------------------------------
void delayed_stop_start(uint32 delay_ms)
{
    // 检查是否启用延迟停车功能
    if (!delayed_stop_enabled)
    {
        // 功能未启用，直接返回
        return;
    }

    if (delay_ms == 0)
    {
        // 如果延迟时间为0，立即停车
        enable = false;
        momentum_wheel_control(0);
        drive_wheel_control(0);
        state.is_active = false;

        // 蜂鸣器响1秒
        buzzer_beep(1, 1000, 0);
        return;
    }

    // 设置延迟停车参数
    state.is_active = true;
    state.delay_time_ms = delay_ms;
    state.remaining_time_ms = delay_ms;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     启动延迟停车（使用全局参数delayed_stop_time_ms）
// 参数说明     void
// 返回参数     void
// 使用示例     delayed_stop_start_with_param(); // 使用菜单中设置的时间
// 备注信息     使用全局变量delayed_stop_time_ms作为延迟时间
//-------------------------------------------------------------------------------------------------------------------
void delayed_stop_start_with_param(void)
{
    delayed_stop_start(delayed_stop_time_ms);
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     取消延迟停车
// 参数说明     void
// 返回参数     void
// 使用示例     delayed_stop_cancel(); // 取消延迟停车
// 备注信息     取消延迟停车任务，不影响当前电机运行状态
//-------------------------------------------------------------------------------------------------------------------
void delayed_stop_cancel(void)
{
    state.is_active = false;
    state.remaining_time_ms = 0;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     延迟停车更新函数（需要在control()函数中调用）
// 参数说明     void
// 返回参数     void
// 使用示例     delayed_stop_update(); // 在control()函数中调用
// 备注信息     更新延迟停车计时器，到期后自动停车并响蜂鸣器
//              必须在enable=true时才调用，否则不会计时
//-------------------------------------------------------------------------------------------------------------------
void delayed_stop_update(void)
{
    // 如果延迟停车未激活，直接返回
    if (!state.is_active)
    {
        return;
    }

    // 递减剩余时间
    if (state.remaining_time_ms > 0)
    {
        state.remaining_time_ms--;
    }

    // 时间到，执行停车
    if (state.remaining_time_ms == 0)
    {
        // 禁用PID控制系统
        enable = false;

        // 停止所有电机
        momentum_wheel_control(0);
        drive_wheel_control(0);

        // 清除延迟停车状态
        state.is_active = false;

        // 蜂鸣器响1秒提示停车
        buzzer_beep(1, 1000, 0);
    }
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     查询是否有延迟停车任务在运行
// 参数说明     void
// 返回参数     bool: true=有延迟停车任务在运行, false=无
// 使用示例     if(delayed_stop_is_active()) { ... }
// 备注信息
//-------------------------------------------------------------------------------------------------------------------
bool delayed_stop_is_active(void)
{
    return state.is_active;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     获取剩余停车时间
// 参数说明     void
// 返回参数     uint32: 剩余停车时间(毫秒)，如果未激活返回0
// 使用示例     uint32 remaining = delayed_stop_get_remaining_time();
// 备注信息
//-------------------------------------------------------------------------------------------------------------------
uint32 delayed_stop_get_remaining_time(void)
{
    if (!state.is_active)
    {
        return 0;
    }
    return state.remaining_time_ms;
}
