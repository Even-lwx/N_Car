/*********************************************************************************************************************
 * TC264 Opensourec Library 即（TC264 开源库）是一个基于官方 SDK 接口的第三方开源库
 * Copyright (c) 2022 SEEKFREE 逐飞科技
 *
 * 文件名称          turn_compensation.h - 转弯补偿控制器
 * 功能说明          补偿转弯时由于离心力和舵机角度导致的机械零点漂移
 * 开发环境          ADS v1.9.4
 * 适用平台          TC264D
 ********************************************************************************************************************/

#ifndef TURN_COMPENSATION_H
#define TURN_COMPENSATION_H

#include "zf_common_headfile.h"

// *************************** 转弯补偿功能说明 ***************************
// 问题：
// 1. 转弯时离心力使车体向外侧倾斜
// 2. 舵机角度改变车体重心分布
// 3. 实际平衡角度不再是静止时的机械零点
//
// 解决方案：动态零点补偿算法
// 当车辆转向时，飞轮需要补偿一个额外的平衡角度偏置
// 这个偏置与转向角度和车速成正比
//
// 补偿公式：
// dynamic_zero = (servo_angle - servo_center) × K_angle × K_speed × |speed|
//
// 计算步骤：
// 1. 计算舵机偏差：servo_deviation = servo_angle - servo_center
// 2. 计算基础补偿：base_compensation = K_angle × servo_deviation
// 3. 计算速度增益：speed_gain = K_speed × |speed|
// 4. 计算动态零点：dynamic_zero = base_compensation × speed_gain
// 5. 限幅处理：限制在 [-turn_comp_max, +turn_comp_max] 范围
//
// 物理意义：
// - 当速度为0时，补偿为0（静止转向不产生离心力）
// - 速度越快，离心力越大，补偿越大
// - 转向角度越大，需要的补偿越大
//
// 参数说明：
// - K_angle: 舵机角度增益系数（建议范围: 0.01 ~ 1.0）
// - K_speed: 速度增益系数（建议范围: 0.001 ~ 0.1）
// - servo_angle: 当前舵机角度（度）
// - servo_center: 舵机中点角度（默认90度）
// - speed: 当前速度（编码器绝对值）
// - turn_comp_max: 最大补偿限制（默认±8度）

// *************************** 全局变量声明 ***************************
extern float turn_comp_k_angle;      // 舵机角度增益系数（建议范围: 0.01 ~ 1.0）
extern float turn_comp_k_speed;      // 速度增益系数（建议范围: 0.001 ~ 0.1）
extern float turn_comp_max;          // 最大补偿角度限制（防止补偿过大，默认±8度）
extern float servo_center_angle;     // 舵机中点角度（默认90度，可调整）

// *************************** 函数声明 ***************************

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     初始化转弯补偿控制器
// 参数说明     void
// 返回参数     void
// 使用示例     turn_compensation_init();
// 备注信息     在系统初始化时调用，设置默认参数
//-------------------------------------------------------------------------------------------------------------------
void turn_compensation_init(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     计算转弯补偿角度
// 参数说明     servo_angle: 当前舵机角度
//              speed: 当前速度（编码器反馈值）
// 返回参数     float: 补偿角度（度）
// 使用示例     float compensation = turn_compensation_calculate(servo_angle, encoder[0]);
// 备注信息     返回值为补偿角度，需要叠加到目标角度或机械零点上
//              正值表示车需要向左倾斜补偿，负值表示向右倾斜补偿
//-------------------------------------------------------------------------------------------------------------------
float turn_compensation_calculate(float servo_angle, float speed);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     获取当前补偿值（用于调试显示）
// 参数说明     void
// 返回参数     float: 当前补偿角度（度）
// 使用示例     float comp = turn_compensation_get_current();
// 备注信息     返回上次计算的补偿值
//-------------------------------------------------------------------------------------------------------------------
float turn_compensation_get_current(void);

#endif
